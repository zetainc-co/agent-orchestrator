<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Liquilegal Chat — Test</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0d1117;
      color: #e6edf3;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 720px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 12px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
    }
    .header-dot { width: 10px; height: 10px; border-radius: 50%; background: #3fb950; flex-shrink: 0; }
    .header-title { font-size: 14px; font-weight: 600; color: #e6edf3; }
    .header-key {
      font-size: 11px;
      font-family: monospace;
      color: rgba(230,237,243,0.35);
      margin-left: auto;
    }
    #btn-new {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      color: rgba(230,237,243,0.6);
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all .15s;
    }
    #btn-new:hover { background: rgba(255,255,255,0.1); color: #e6edf3; }

    /* Config bar */
    .config-bar {
      display: flex;
      gap: 8px;
    }
    .config-bar input {
      flex: 1;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 12px;
      font-family: monospace;
      color: #e6edf3;
      outline: none;
      transition: border-color .15s;
    }
    .config-bar input:focus { border-color: rgba(63,185,80,0.4); }
    .config-bar input::placeholder { color: rgba(230,237,243,0.25); }

    /* Messages */
    #messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-right: 4px;
      scroll-behavior: smooth;
    }
    #messages::-webkit-scrollbar { width: 4px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    .msg {
      display: flex;
      flex-direction: column;
      max-width: 80%;
      gap: 4px;
    }
    .msg.user { align-self: flex-end; align-items: flex-end; }
    .msg.bot  { align-self: flex-start; align-items: flex-start; }

    .bubble {
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.55;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.user .bubble {
      background: #238636;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg.bot .bubble {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      color: #e6edf3;
      border-bottom-left-radius: 4px;
    }
    .msg.bot .bubble.streaming { opacity: 0.85; }

    .meta {
      font-size: 10px;
      color: rgba(230,237,243,0.25);
      padding: 0 4px;
    }

    /* Typing indicator */
    .typing .bubble {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 12px 16px;
    }
    .typing .dot {
      width: 6px; height: 6px;
      background: rgba(230,237,243,0.4);
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }
    .typing .dot:nth-child(2) { animation-delay: .2s; }
    .typing .dot:nth-child(3) { animation-delay: .4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: .4; }
      40% { transform: translateY(-5px); opacity: 1; }
    }

    /* Input */
    .input-area {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    #input {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 14px;
      color: #e6edf3;
      outline: none;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      font-family: inherit;
      transition: border-color .15s;
      line-height: 1.4;
    }
    #input:focus { border-color: rgba(63,185,80,0.4); }
    #input::placeholder { color: rgba(230,237,243,0.25); }

    #send {
      background: #238636;
      border: none;
      border-radius: 12px;
      width: 44px;
      height: 44px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .15s;
      flex-shrink: 0;
    }
    #send:hover { background: #2ea043; }
    #send:disabled { background: rgba(35,134,54,0.3); cursor: not-allowed; }
    #send svg { width: 18px; height: 18px; fill: #fff; }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: rgba(230,237,243,0.2);
      font-size: 13px;
    }
    .empty-state svg { width: 36px; height: 36px; opacity: .3; }
  </style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="header-dot" id="status-dot"></div>
    <span class="header-title" id="agent-name">Dify Chat Test</span>
    <span class="header-key" id="key-display"></span>
    <button id="btn-new" title="Nueva conversación">↺ Nueva</button>
  </div>

  <!-- Config -->
  <div class="config-bar">
    <input id="app-key" type="text" placeholder="App Key  (ej: app-xxxxx)" value="app-sTjal9vNsBQArgm2eOAGVwjA" />
    <input id="dify-url" type="text" placeholder="Dify URL" value="http://localhost/v1" style="max-width:200px" />
  </div>

  <!-- Messages -->
  <div id="messages">
    <div class="empty-state" id="empty">
      <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
      Escribe un mensaje para comenzar
    </div>
  </div>

  <!-- Input -->
  <div class="input-area">
    <textarea id="input" placeholder="Escribe aquí..." rows="1"></textarea>
    <button id="send">
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>

</div>

<script>
  const appKeyEl  = document.getElementById('app-key');
  const urlEl     = document.getElementById('dify-url');
  const messagesEl = document.getElementById('messages');
  const inputEl   = document.getElementById('input');
  const sendBtn   = document.getElementById('send');
  const emptyEl   = document.getElementById('empty');
  const agentName = document.getElementById('agent-name');
  const keyDisplay = document.getElementById('key-display');
  const statusDot  = document.getElementById('status-dot');
  const btnNew     = document.getElementById('btn-new');

  let conversationId = null;
  let loading = false;
  const userId = 'chat-test-' + Math.random().toString(36).slice(2, 8);

  // Load agent info on key change
  let infoDebounce;
  appKeyEl.addEventListener('input', () => {
    clearTimeout(infoDebounce);
    infoDebounce = setTimeout(loadAgentInfo, 600);
  });

  async function loadAgentInfo() {
    const key = appKeyEl.value.trim();
    if (!key) return;
    keyDisplay.textContent = key.slice(0, 16) + '...';
    try {
      const r = await fetch(`${urlEl.value.trim()}/info`, {
        headers: { Authorization: `Bearer ${key}` }
      });
      if (r.ok) {
        const d = await r.json();
        agentName.textContent = d.name || 'Agente';
        statusDot.style.background = '#3fb950';
      } else {
        agentName.textContent = 'Key inválida';
        statusDot.style.background = '#f85149';
      }
    } catch {
      agentName.textContent = 'Sin conexión';
      statusDot.style.background = '#e3b341';
    }
  }

  loadAgentInfo();

  btnNew.addEventListener('click', () => {
    conversationId = null;
    messagesEl.innerHTML = '';
    messagesEl.appendChild(emptyEl);
    emptyEl.style.display = 'flex';
  });

  // Auto-resize textarea
  inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
  });

  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  sendBtn.addEventListener('click', sendMessage);

  function addMessage(role, text, streaming = false) {
    emptyEl.style.display = 'none';
    const wrap = document.createElement('div');
    wrap.className = `msg ${role}`;
    const bubble = document.createElement('div');
    bubble.className = 'bubble' + (streaming ? ' streaming' : '');
    bubble.textContent = text;
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
    wrap.appendChild(bubble);
    wrap.appendChild(meta);
    messagesEl.appendChild(wrap);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return bubble;
  }

  function addTyping() {
    emptyEl.style.display = 'none';
    const wrap = document.createElement('div');
    wrap.className = 'msg bot typing';
    wrap.id = 'typing';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    wrap.appendChild(bubble);
    messagesEl.appendChild(wrap);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function removeTyping() {
    document.getElementById('typing')?.remove();
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text || loading) return;
    const key = appKeyEl.value.trim();
    const baseUrl = urlEl.value.trim();
    if (!key) { alert('Ingresa un App Key'); return; }

    loading = true;
    sendBtn.disabled = true;
    inputEl.value = '';
    inputEl.style.height = 'auto';

    addMessage('user', text);
    addTyping();

    const payload = {
      query: text,
      inputs: { contact_name: userId },
      user: userId,
      response_mode: 'streaming',
    };
    if (conversationId) payload.conversation_id = conversationId;

    let botBubble = null;
    let answer = '';

    try {
      const resp = await fetch(`${baseUrl}/chat-messages`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${key}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err.message || `HTTP ${resp.status}`);
      }

      removeTyping();
      botBubble = addMessage('bot', '', true);

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop();

        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          const raw = line.slice(6).trim();
          if (raw === '[DONE]') continue;
          try {
            const chunk = JSON.parse(raw);
            if (chunk.event === 'agent_message' || chunk.event === 'message') {
              answer += chunk.answer || '';
              botBubble.textContent = answer;
              botBubble.classList.remove('streaming');
              messagesEl.scrollTop = messagesEl.scrollHeight;
            }
            if (chunk.conversation_id) conversationId = chunk.conversation_id;
          } catch {}
        }
      }

    } catch (err) {
      removeTyping();
      addMessage('bot', `⚠️ Error: ${err.message}`);
    } finally {
      loading = false;
      sendBtn.disabled = false;
      inputEl.focus();
    }
  }
</script>
</body>
</html>
